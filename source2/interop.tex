\section{Interoperability}

Our primary interoperability testing is based on our ``smokeping''-like tests.
While smokeping measures latency for names/addresses, our tests aim to establish
whether and which ECH configurations interoperate or fail to do so.

\subsection{Test Clients}

We mainly do this via a set of hourly cronjobs running on the test.defo.ie VM
that attempt to access 67 URLs (some deliberately with broken configurations)
from six different clients (described in Table \ref{tab:smclients}.
Between version 1 and 2 of this report client packages have been updated as
per the version numbers shown in Table \ref{tab:smclients}. The test scripts
that call those client and the cron setup remain the same.
We report results for the most recent 6 runs at
\url{https://test.defo.ie/smokeping-summary.php}.

\tiny
\begin{longtblr} [
        caption = {Smokeping clients},
        label = {tab:smclients}
    ] {
        colspec = {| l | p{0.7\linewidth} |},
        rowhead = 1
    }
    \hline
        Test Client Name & Details\\
    \hline
        Chromium & headless browser tests via Selenium\\
        & 2025-01 Version: 131.0.6778.85;  2025-10 Version: 140.0.7339.185\\
        & Python script: \url{https://github.com/defo-project/ech-dev-utils/blob/main/scripts/selenium_test.py}\\
        & ECH implementation based on boringssl\\
        & Uses DoH to \url{https://chrome.cloudflare-dns.com/dns-query}\\

    \hline
        curl & bash script using curl\\
        & 2025-01 Version: 8.11.1-DEV; 2025-10 Version: 8.17.0-DEV\\
        & Bash script: \url{https://github.com/defo-project/ech-dev-utils/blob/main/scripts/smoke_ech_curl.sh}\\
        & curl currently only pays attention the the first HTTPS resource record seen in DNS answers\\
        & ECH implementation based on OpenSSL\\
        & Uses DoH to \url{https://one.one.one.one/dns-query}\\

    \hline
        Firefox & headless browser tests via Selenium\\
        & 2025-01 Version: 133.0; 2025-10 Version: 143.0\\
        & Python script: \url{https://github.com/defo-project/ech-dev-utils/blob/main/scripts/selenium_test.py}\\
        & ECH implementation based on NSS\\
        & Uses DoH to \url{https://one.one.one.one/dns-query}\\

    \hline
        golang & custom golang programme and bash script\\
        & 2025-01 Version: golang 1.23; 2025-10 Version: golang 1.24.4\\
        & Golang programme: \url{https://github.com/defo-project/ech-dev-utils/blob/main/scripts/ech_url.go}\\
        & Bash script: \url{https://github.com/defo-project/ech-dev-utils/blob/main/scripts/smoke_ech_go.sh}\\
        & ECH implementation developed for golang\\
        & Uses DoH to \url{https://cloudflare-dns.com/dns-query} using GET\\

    \hline
        rustls & custom rustls programme and bash script\\
        & 2025-01 Version: rustls 0.23.19; 2025-10 Version: rustls 0.23.32\\
        & Rustls programme: \url{https://github.com/defo-project/ech-dev-utils/blob/main/scripts/ech_url.rs}\\
        & Bash script: \url{https://github.com/defo-project/ech-dev-utils/blob/main/scripts/smoke_ech_rs.sh}\\
        & ECH implementation developed for rustls\\
        & Uses DoH to Google DNS (8.8.8.8/8.8.4.4) via Hickory DNS\\

    \hline
        Python & custom CPython build and python script\\
        & 2025-01 Version: CPython 3.13; 2025-10 Version: CPython 3.13.1\\
        & Python script: \url{https://github.com/defo-project/ech-dev-utils/blob/main/scripts/ech_url.py}\\
        & Bash script: \url{https://github.com/defo-project/ech-dev-utils/blob/main/scripts/smoke_ech_py.sh}\\
        & ECH implementation based on OpenSSL\\
        & Uses Do53 to system resolver\\

    \hline

\end{longtblr}
\normalsize

There are some notes on these tests worth calling out in case someone wants to
reproduce them:

\begin{itemize}

    \item Some of the headless browser tests (e.g. with badly encoded
        ECHConfigList values) will cause Selenium to throw exceptions, so test
        scripts need to catch those in order to properly determine that we got
        an expected failure.

    \item Firefox will not attempt ECH to a name when the hostname of the test
        machine/VM is beneath the ``second level domain''\footnote{Or 2LD, as
        defined e.g. at
        \url{https://en.wikipedia.org/wiki/Second-level_domain}.} for that
        name, thus causing unexpected failures if that hostname matches the
        origin of a test URL. In our case, we run both servers and test clients
        on the same VM (``test.defo.ie'') so we have to set the hostname on the
        VM to something ``peculiar'' for tests to run as expected. (That of
        course causes ``sudo'' to complain which could disturb logs.)

    \item In the course of testing ECH in recent years, we have repeatedly made
        one misconfiguration error: using ``.'' as the target name in HTTPS RRs
        for ports other then 443, when the correct thing do is to include the
        origin as the target name in such cases. That is, when making an HTTPS
        RR for \url{https://example.com:12345/} one needs to publish an HTTPS
        RR at ``\_12345.\_https.example.com'' and the (presentation) value of
        that record needs to start with ``1 example.com ...'' where 1 is the
        priority and example.com is that targetName. So simply copying the
        value of the HTTPS RR for port 443 and re-publishing that for another
        port is not sufficient for interoperability. (But also does work for
        some clients in some cases, making it easier to accidentally do this
        and not notice.)

    \item Tests are run hourly, with curl tests at the top of the hour,
        CPython tests at :05, Firefox at :10, Chromium at :20, golang at :30
        and rustls at :40. The test summary page is generated at :45.
        The TTLs for DNS records below test.defo.ie are all set to 10 seconds.
        For our other DEfO test services (e.g. draft-13.esni.defo.ie cases)
        TTLs are set to 1800 seconds.

\end{itemize}

We also have a standalone test suite on Android to run our ECH-enabled
Conscrypt build against a number of domains
(\url{https://github.com/defo-project/EchInteropTest}).  This manually-run test
passes on all of the draft-13.esni.defo.ie test servers, defo.ie itself,
Google's tls-ech.dev, and two Cloudflare domains that support ECH.

\subsection{Results}

The set of 67 test URLs covers all of the server technologies listed in Table
\ref{tab:servers} though as all of those use OpenSSL for ECH, we direct most
of the URLs towards one nginx instance. On our test VM, we have an haproxy
instance (not doing ECH) listening on port 443, that routes TLS sessions to
the ECH-enabled web servers, namely, nginx (port 15443), apache (15444),
lighttpd (15445) and two instances of ``openssl s\_server'', one with a
standard configuration on port 15447, and one, that only supports the p-384
curve for TLS key exchange on port 15448. That last server's configuration will
trigger TLS HelloRetryRequest for many TLS clients. The back-end ports for all
servers (e.g. 15443 for nginx) are also open. Our test URLs and associated
HTTPS RRs can therefore be exercised both for port 443 and the relevant
back-end port, but in most cases we have only set those up for the nginx
back-end instance as testing the same setup on different web server instances
wouldn't be likely to reveal much new information.  The test set also include
URLs for the test services listed in Table \ref{tab:testservers}.  Some test
URLs have ``broken'' configurations, e.g. with badly encoded HTTPS resource
records, or have specification-conformant configurations that we expect may not
work.

We have 6 clients testing hourly against 67 URLs, giving us 402 measurements
per hour. The test setup underlying these URLs are further described in
Appendix~\ref{app:testdescriptions} and the list of URLs and expected outcomes
is shown in Appendix~\ref{app:urls}.  The full set of URLs and the last 6 hours
of test outcomes are also at \url{https://test.defo.ie/smokeping-summary.php}
or web pages with (most of) the test URLs loaded via an Iframe can be accessed
at \url{https://test.defo.ie/iframe_tests_sort.html}. That web page also
includes some explanatory text about each test URL.

Table \ref{tab:itests} below shows, for each test URL and each client,
the ratio of expected and total results as per version 1 of this
report.~\footnote{Table \ref{tab:itests} is produced
using \url{https://github.com/defo-project/ech-dev-utils/blob/main/scripts/smokeping-summary-report.py}.}
Table \ref{tab:itests2} updates that for a recent interval.
Table \ref{tab:one-v-two} shows the summary lines from both.

\begin{center}
    \input{tt}
\end{center}

\begin{center}
    \input{tt2}
\end{center}


\tiny
\begin{longtblr} [
        caption = {ECH interop tests compared.},
        label = {tab:one-v-two}
    ] {
        colspec = {| l | c | c | c | c | c | c | c |},
        rowhead = 1
    }
    \hline
    Time  & chromium  & curl  & firefox  & golang  & rustls  & python & Overall \\ \hline
2025-01  & \textbf{0.85/10653 }  & 1.00/10653  & \textbf{0.82/10653 }  & \textbf{0.94/10586 }  & \textbf{0.88/10586 }  & \textbf{0.91/10653 } & \textbf{0.90/63784} \\ \hline
2025-10   & \textbf{0.69/52796 }  & 1.00/52796  & \textbf{0.88/52796 }  & \textbf{0.93/52796 }  & \textbf{0.87/52729 }  & \textbf{0.94/52796 } & \textbf{0.88/316709} \\ \hline
\hline
\end{longtblr}
\normalsize

Note that the numbers in Tables \ref{tab:itests} and \ref{tab:itests2} are not
a direct measure of the ``quality'' of the client - they are a snapshot of
counts of how often we see expected outcomes for the specific test setting, and
the failure to see that outcome is sometimes due to imperfection in the test
setup, or even network conditions, and not the client.  Nonetheless, the
numbers are useful in terms of pointing us at where we can look for improvement
- to help with that, cells in the table where we see fewer than 95\% of the
results being as expected are in \textbf{bold}.  Based on that, the set of
``interesting'' things arising from Tables \ref{tab:itests} and \ref{tab:itests2}
include:

\begin{itemize}

    \item The numbers for chromium seem to have gotten notably worse, both in
        terms of the overall percentage of expected results and the range of
        test URLs where we see failures. This seems to be due to the browser's
        ``impatience'' at not waiting for HTTPS RR answers as described earlier.

   \item Firefox seems to have improved to a notable degree, though still getting
       less than 90\% of expected results overall.

   \item Performance in terms of producing our expected results doesn't seem to
       have changed for the other test clients.

   \item A number of the notes from version 1 of this report on problems with
       specific tests are no longer needed - for example the python client with
       the test in row 13 used to never work and now works 100\% of the time.
       There are a number of similar examples.

    \item Line 23 - browsers seem to dislike
        \url{https://draft-13.esni.defo.ie:12413/}.  That's due to our test
        result handlers and is not a failure in the clients or servers. That test case is
        an ECH shared-mode haproxy instance with lighttpd as the backend. As
        lighttpd is the backend it can't produce an HTTP response that
        indicates ECH worked as ECH was terminated with TLS at the haproxy
        instance. It's unclear how we can handle this test case when browsers
        don't themselves indicate ECH success or failure.

    \item Line 37 - it's not clear why publishing many (20) identical HTTPS RRs
        would work for port 443 for browsers but not off port 443.

    \item Line 46 - as \url{https://myechtest.site} returns variously malformed
        retry-configs, sometimes the malformed-ness is not detected by clients.
        Our test code does correctly interpret some situations but not all.

    \item The test setup for lines 51/52 calls for use of P256-HKDF-SHA256 for
        the KEM, a KDF of HKDF-SHA384 and the CHACHA20-POLY-1305 AEAD.  It
        seems that some implementations (including rustls) don't support that
        combination as their ECH code is compiled/configured on a per-HPKE suite basis
        so they don't support this combination even though they support all the
        component algorithms.  In addition, neither the ECH nor HPKE
        specifications nominate one or a small number of HPKE suites as
        mandatory-to-implement (MTI).  Sadly, rather than a small set of MTI
        suites, HPKE defines 96 possibilities in RFC9180 \cite{rfc9180}
        arguably giving rise to this interoperability issue.  Whether that
        makes this a good or a bad test case is perhaps a matter of opinion.
        (The oddball selection is the author's fault.) This is discussed a
        little in
        \url{https://github.com/defo-project/ech-interop-report/issues/2}.)

    \item Lines 51/52 - curl and CPython do work with our oddball P256
        combination, but Chromium, Firefox, golang and rustls (as explained above)
        do not support that choice.

\end{itemize}

Some additional issues encountered in validating test results are described
in Appendix~\ref{app:alongtheway}.

